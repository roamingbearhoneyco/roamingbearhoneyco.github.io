---
import BlogLayout from '../../layouts/BlogLayout.astro';

interface Frontmatter {
  title: string;
  date: string;
  description: string;
  image?: { src: string; alt: string };
  draft?: boolean;
}

interface PostModule {
  frontmatter: Frontmatter;
}

type Post = Frontmatter & {
  slug: string;
  displayDate: string;
};

// ✅ Get posts inside getStaticPaths to avoid scoping errors
export function getStaticPaths({ paginate }: { paginate: <T>(data: T[], opts: { pageSize: number }) => any[] }) {
  const locale = 'en-US';
  const formatDate = (d: string) =>
    new Date(d).toLocaleDateString(locale, {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
    });

  const modules = import.meta.glob<PostModule>('./*.md', { eager: true });

  const posts: Post[] = Object.entries(modules)
    .map(([path, mod]) => {
      const slug = path.match(/\.\/(.+)\.md$/)?.[1]!;
      const { title, date, description, image, draft } = mod.frontmatter;
      return {
        slug,
        title,
        date,
        description,
        image,
        draft,
        displayDate: formatDate(date),
      };
    })
    .filter((p) => !p.draft)
    .sort((a, b) => new Date(b.date).valueOf() - new Date(a.date).valueOf());

  return paginate(posts, { pageSize: 5 });
}

// ✅ Page props inferred from Astro.props
const page = Astro.props.page as {
  data: Post[];
  currentPage: number;
  lastPage: number;
  url: {
    current: string;
    prev?: string;
    next?: string;
  };
};
---

<BlogLayout>
  <div slot="heading" class="w-full text-center mb-10">
    <h1 class="text-4xl font-bold">Whispers From the Hive</h1>
  </div>

    {page.data.map((post) => (
      <li>
        <a
          href={`/blog/${post.slug}`}
          class="block bg-white rounded-lg overflow-hidden shadow transition hover:shadow-lg"
        >
          {post.image && (
            <img
              src={post.image.src}
              alt={post.image.alt}
              class="w-full h-48 object-cover"
            />
          )}
          <div class="p-4">
            <h2 class="text-xl font-semibold mb-2">{post.title}</h2>
            <time class="text-sm text-gray-400">{post.displayDate}</time>
            <p class="mt-2 text-gray-700">{post.description}</p>
          </div>
        </a>
      </li>
    ))}

  <Fragment slot="pagination">
  <nav class="flex items-center gap-4">
    {page.url.prev && (
      <a href={page.url.prev} class="px-4 py-2 border rounded hover:bg-gray-100 transition">
        ← Previous
      </a>
    )}
    <span class="px-4 py-2 border rounded text-gray-500">
      Page {page.currentPage} of {page.lastPage}
    </span>
    {page.url.next && (
      <a href={page.url.next} class="px-4 py-2 border rounded hover:bg-gray-100 transition">
        Next →
      </a>
    )}
  </nav>
</Fragment>

</BlogLayout>
